/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2024 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <stdio.h>
#include "led_bar.h"
#include "gpio.h"
#include "lcd.h"
#include "delay.h"
#include "rcc.h"
#include "tim.h"

uint16_t count = 0;
bool spooj = false;

// Control pin = PB0
// Timer 3 Channel 3 = AF2
int main(void)
{
	LcdSetup();
	LcdInit();
	LcdClear();
	LedBar led_bar = LedBarInit();
	LedBarOn(&led_bar, 0);
	volatile Gpio *gpio_b = GPIO_B;
	volatile Tim *tim3 = TIM3;
	RccEnable(tim3);
	// Enable pull-up resistor
	gpio_b->pupdr &= ~(3 << 0);
	// Set PB0 to alternate function mode
	gpio_b->moder &= ~(3 << 0);
	gpio_b->moder |= (2 << 0);
	// Set PB0 to AF2
	gpio_b->afrl &= ~(0xF << 0);
	gpio_b->afrl |= (2 << 0);

	// Set up timer 3
	tim3->arr = 0xFFFFFFFF;
	tim3->dier |= 0x00000008;
	tim3->ccmr2 &= ~0xFF;
	tim3->ccmr2 |= 0x00000001;
	tim3->ccer |= 0xB00;
	tim3->cr1 |= 0x00000081;
	tim3->egr |= 0x0001;


	while (1)
	{
		count = tim3->cnt;
		char buffer[16];
		sprintf(buffer, "Count: %d", count);
		LcdClear();
		LcdHome();
		LcdWriteStr(buffer);
		while (!spooj);
		spooj = false;
	}
}

void TIM3_IRQHandler(void)
{
	volatile Tim *tim3 = TIM3;
	// count = tim3->cnt;
	spooj = true;
}
